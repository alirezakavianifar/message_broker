# راهنمای تست پیاده‌سازی Thin Client - Message Broker

## مقدمه

این بسته شامل تمام فایل‌ها و مستندات لازم برای تست پیاده‌سازی **Thin Client** سیستم Message Broker است.

## Thin Client چیست؟

**Thin Client** به این معنی است که کلاینت‌ها می‌توانند پیام‌ها را بدون نیاز به نصب Python یا کتابخانه‌های خاص، فقط با استفاده از هر HTTP client (مثل curl) ارسال کنند.

### مزایا:
- ✅ نیازی به نصب Python روی کامپیوتر کلاینت نیست
- ✅ نیازی به virtual environment نیست
- ✅ می‌توانید از curl، Postman یا هر زبان برنامه‌نویسی استفاده کنید
- ✅ فقط یک درخواست HTTP ساده لازم است

## ساختار فایل ZIP

بعد از استخراج فایل ZIP، ساختار زیر را خواهید دید:

```
thin_client_package/
├── README.md                    ← شروع از اینجا (انگلیسی)
├── README_FA.md                 ← این فایل (راهنمای فارسی)
├── QUICK_START.md               ← راهنمای سریع (انگلیسی)
│
├── docs/                        ← پوشه مستندات
│   ├── API_REFERENCE.md         ← مستندات کامل API
│   ├── PLATFORM_GUIDE.md        ← راهنمای مختص هر پلتفرم
│   └── USER_MANUAL.md           ← راهنمای کامل کاربر
│
├── scripts/                     ← اسکریپت‌های آماده استفاده
│   ├── send_message_windows.ps1 ← برای Windows
│   ├── send_message_linux.sh    ← برای Linux/Mac/WSL
│   └── send_message_python.py   ← نسخه Python (اختیاری)
│
└── tests/                       ← فایل‌های تست
    ├── test_message_valid.json   ← نمونه پیام معتبر
    └── test_message_invalid.json ← نمونه پیام نامعتبر
```

## پیش‌نیازها

قبل از شروع تست، مطمئن شوید:

1. ✅ **سرور Proxy در حال اجرا است** (پورت 8001)
2. ✅ **Redis در حال اجرا است**
3. ✅ **گواهینامه‌های کلاینت** موجود است:
   - `client.crt` - گواهینامه کلاینت
   - `client.key` - کلید خصوصی کلاینت (محافظت کنید!)
   - `ca.crt` - گواهینامه CA

## نحوه شروع (مرحله به مرحله)

### مرحله 1: بررسی سرور

ابتدا مطمئن شوید سرور Proxy در حال اجرا است:

```bash
# Windows PowerShell:
curl.exe http://localhost:8001/api/v1/health

# Linux/Mac:
curl http://localhost:8001/api/v1/health
```

اگر پاسخ دریافت کردید، سرور در حال اجرا است. ✅

### مرحله 2: انتخاب پلتفرم

#### اگر از Windows استفاده می‌کنید:

1. فایل `scripts/send_message_windows.ps1` را پیدا کنید
2. PowerShell را باز کنید
3. به پوشه `scripts` بروید:
   ```powershell
   cd scripts
   ```
4. اسکریپت را اجرا کنید:
   ```powershell
   .\send_message_windows.ps1 -Sender "+1234567890" -Message "تست پیام"
   ```

**نکته مهم**: در Windows، از اسکریپت PowerShell استفاده کنید. `curl.exe` در Windows ممکن است مشکل داشته باشد.

#### اگر از Linux/Mac/WSL استفاده می‌کنید:

**روش 1: استفاده از اسکریپت Bash (ساده‌تر)**

```bash
cd scripts
chmod +x send_message_linux.sh
./send_message_linux.sh "+1234567890" "تست پیام"
```

**روش 2: استفاده مستقیم از curl**

```bash
curl -X POST https://your-server:8001/api/v1/messages \
  --cert client.crt --key client.key --cacert ca.crt \
  -H "Content-Type: application/json" \
  -d '{"sender_number": "+1234567890", "message_body": "تست پیام"}'
```

### مرحله 3: قرار دادن گواهینامه‌ها

گواهینامه‌های کلاینت را در پوشه `scripts` قرار دهید:
- `client.crt`
- `client.key`
- `ca.crt`

یا مسیر آن‌ها را در اسکریپت‌ها به‌روزرسانی کنید.

## مثال کامل تست

### Windows:

```powershell
# 1. به پوشه scripts بروید
cd scripts

# 2. گواهینامه‌ها را بررسی کنید
dir client.crt, client.key, ca.crt

# 3. اسکریپت را اجرا کنید
.\send_message_windows.ps1 -Sender "+989123456789" -Message "این یک تست است"
```

### Linux/Mac:

```bash
# 1. به پوشه scripts بروید
cd scripts

# 2. گواهینامه‌ها را بررسی کنید
ls client.crt client.key ca.crt

# 3. اسکریپت را اجرا کنید
./send_message_linux.sh "+989123456789" "این یک تست است"
```

## پاسخ موفقیت‌آمیز

اگر همه چیز درست کار کند، پاسخ زیر را دریافت خواهید کرد:

```json
{
  "message_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "queued",
  "client_id": "your-client-id",
  "queued_at": "2025-12-21T10:30:00Z",
  "position": 1
}
```

این یعنی پیام با موفقیت در صف قرار گرفته است! ✅

## خطاهای متداول و راه حل

### خطا: "Certificate not found"

**مشکل**: فایل‌های گواهینامه پیدا نشد.

**راه حل**:
- مطمئن شوید فایل‌های `client.crt`, `client.key`, و `ca.crt` در پوشه `scripts` هستند
- یا مسیر آن‌ها را در اسکریپت به‌روزرسانی کنید

### خطا: "Connection refused"

**مشکل**: نمی‌تواند به سرور متصل شود.

**راه حل**:
1. بررسی کنید سرور Proxy در حال اجرا است:
   ```bash
   curl http://localhost:8001/api/v1/health
   ```
2. بررسی تنظیمات فایروال
3. بررسی اینکه پورت 8001 باز است

### خطا: "Invalid phone number format"

**مشکل**: فرمت شماره تلفن اشتباه است.

**راه حل**:
- شماره تلفن باید با `+` شروع شود (مثال: `+989123456789`)
- نباید فاصله یا خط تیره داشته باشد
- فقط اعداد بعد از `+` مجاز است

### خطا: "Invalid or missing client certificate"

**مشکل**: گواهینامه کلاینت نامعتبر است یا موجود نیست.

**راه حل**:
- بررسی کنید گواهینامه‌ها درست هستند
- بررسی کنید گواهینامه منقضی نشده است
- با مدیر سیستم تماس بگیرید برای دریافت گواهینامه جدید

## تست با فایل‌های نمونه

در پوشه `tests` دو فایل نمونه وجود دارد:

1. **test_message_valid.json** - نمونه پیام معتبر
2. **test_message_invalid.json** - نمونه پیام نامعتبر (برای تست اعتبارسنجی)

می‌توانید از این فایل‌ها برای تست استفاده کنید.

## بررسی نتایج تست

بعد از اجرای تست، باید بررسی کنید:

✅ **پیام با موفقیت ارسال شد** (کد پاسخ 202)
✅ **شناسه پیام (message_id) دریافت شد**
✅ **پیام با وضعیت "queued" برگردانده شد**

اگر خطایی دریافت کردید:
- پیام خطا را بخوانید (معمولاً واضح است)
- به بخش "خطاهای متداول" بالا مراجعه کنید
- اگر مشکل حل نشد، با تیم پشتیبانی تماس بگیرید

## خلاصه مراحل تست

1. ✅ فایل ZIP را استخراج کنید
2. ✅ بررسی کنید سرور Proxy در حال اجرا است
3. ✅ گواهینامه‌های کلاینت را آماده کنید
4. ✅ اسکریپت مناسب پلتفرم خود را انتخاب کنید
5. ✅ یک پیام تست ارسال کنید
6. ✅ پاسخ را بررسی کنید

## مستندات بیشتر

برای اطلاعات بیشتر می‌توانید به فایل‌های زیر مراجعه کنید:

- **QUICK_START.md** - راهنمای سریع (انگلیسی)
- **docs/API_REFERENCE.md** - مستندات کامل API
- **docs/PLATFORM_GUIDE.md** - راهنمای مختص پلتفرم
- **docs/USER_MANUAL.md** - راهنمای کامل کاربر

## سوالات متداول

**سوال: آیا به Python نیاز دارم؟**

پاسخ: خیر! Python کاملاً اختیاری است. می‌توانید از curl یا اسکریپت‌های ارائه شده استفاده کنید.

**سوال: کدام روش را استفاده کنم؟**

پاسخ:
- Windows → اسکریپت PowerShell (`send_message_windows.ps1`)
- Linux/Mac → اسکریپت Bash یا curl مستقیم
- هر پلتفرم → اسکریپت Python (اگر Python دارید)

**سوال: گواهینامه‌ها را از کجا بگیرم؟**

پاسخ: از مدیر سیستم یا تیم امنیت درخواست کنید. آن‌ها باید سه فایل به شما بدهند:
- `client.crt`
- `client.key` (این را محافظت کنید!)
- `ca.crt`

## تماس با پشتیبانی

اگر مشکلی داشتید:
1. پیام خطا را کپی کنید
2. مراحل انجام شده را یادداشت کنید
3. با تیم فنی تماس بگیرید

---

**موفق باشید!** اگر سوالی دارید، از مستندات انگلیسی در پوشه `docs` نیز می‌توانید استفاده کنید.

